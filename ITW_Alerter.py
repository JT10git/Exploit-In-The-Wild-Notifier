import smtplib

from colorama import Fore

class Alert:
    '''This class allows us to alert about CVEs using SMPT'''
    def __init__(self, server="localhost", port=1025, frommail="test@test.com", tomail="test@test.com", password=None):
        print(Fore.CYAN, "[-] Configuring Alerter", Fore.RESET)
        self.server = server
        self.port = port
        self.frommail = frommail
        self.tomail = tomail
        self.password = password
    
    def econnect(self):
        try:
            print(Fore.GREEN, "[+] Connecting to Mail Server", Fore.RESET)
            if not(self.password is None):
                self.conn = smtplib.SMTP(self.server[:-1], self.port)
                self.conn.ehlo()
                self.conn.starttls()
                self.conn.login(self.frommail[:-1], self.password)
            else:
                self.conn = smtplib.SMTP(self.server, self.port)
            self.header = 'From: %s\nTo: %s\n' % (self.frommail, self.tomail)
            #content = self.header + "Subject: Testmail\n\nHello Everyone\nThis is a test mail\n"
            #self.conn.sendmail(self.frommail, self.tomail, content)
            print(Fore.GREEN, "[+] Connected to Mail Server", Fore.RESET)
        except:
            print(Fore.RED, "[x] Connection Error: Unable to connect mail server", Fore.RESET)
            exit(0)
    
    def sendalert(self, item):
        try:
            if item is None:
                raise Exception("Empty item")
            msg = self.header + ("Subject: NEW CVE IN THE WILD!!!\n\n%s\nRead more: %s\nDate: %s" % (item.title, item.link, item.published[:10]))
            self.conn.sendmail(self.frommail, self.tomail, msg)
            print(Fore.BLUE, "[-] Mail Sent", Fore.RESET)
        except:
            print(Fore.RED, "[x] Send Error: Unable to mail", Fore.RESET)
            
if __name__ == "__main__":
    server="localhost"
    port=1025
    frommail="test@test.com"
    tomail="test@test.com"
    password=None
    main = Alert(server=server, port=port, frommail=frommail, tomail=tomail, password=password)
    main.econnect()
    main.sendalert(None)